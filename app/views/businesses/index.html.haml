%div#progress
  %div#progress-bar

%div#map

= javascript_include_tag "vendor/leaflet.markercluster-src.js"
:javascript
  //adapted from marker-clustering-realworld 50000 example
  var tiles = L.tileLayer('http://{s}.tiles.mapbox.com/v3/stephs829.j7hoj6gn/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',  
    }),
    latlng = L.latLng(19.542915, -155.665857);

  var map = L.map('map', { center: latlng, zoom: 9, layers: [tiles] });

  var progress = document.getElementById('progress');
  var progressBar = document.getElementById('progress-bar');

  function updateProgressBar(processed, total, elapsed, layersArray) {
    if (elapsed > 1000) {
      // if it takes more than a second to load, display the progress bar:
      progress.style.display = 'block';
      progressBar.style.width = Math.round(processed/total*100) + '%';
    }

    if (processed === total) {
      // all markers processed - hide the progress bar:
      progress.style.display = 'none';
    }
  }

  var markers = L.markerClusterGroup({ chunkedLoading: true, chunkProgress: updateProgressBar });

  var markerList = [];

  //console.log('start creating markers: ' + window.performance.now());
  $.ajax({
    url: '/api/businesses',
    data: 'JSON',
    success: function(data) {
      var marker, title;
      $.each(data, function(key, val) {
        var business = val.business
        if(business.latitude != null && business.longitude != null) {
          title = business["full_address"];
          marker = L.marker(L.latLng(business["latitude"], business["longitude"]), {title: title});
          marker.bindPopup(title);
          markerList.push(marker);
        } else {
          console.log(business.full_address);
        }
      });
      markers.addLayers(markerList);
      map.addLayer(markers);
    },
    error: function(a,b,c) {
      console.log(a,b,c);
    }
  })

  // $.getJSON("/api/businesses", function(data) { });

  //console.log('start clustering: ' + window.performance.now());

  //console.log('end clustering: ' + window.performance.now());